{% extends 'tracker/base.html' %}
{% load vis md %}
{% block content %}
<h2>{{ project.title }} <span class="text-muted" style="font-size:.8em">by {{ project.student.username }}</span></h2>
{% if badges %}
  <div class="mb-2">
    {% for b in badges %}
      <span class="badge rounded-pill text-bg-info me-1">{{ b }}</span>
    {% endfor %}
  </div>
{% endif %}
<div class="row g-3">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span>Tasks</span>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="btn-group" role="group">
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'advisor_project_export_json' project.pk %}">Export JSON</a>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'advisor_project_export_csv' project.pk %}">Export CSV</a>
            <a class="btn btn-sm btn-outline-secondary" href="{% url 'advisor_project_export_zip' project.pk %}">Export ZIP</a>
          </div>
          <form method="get" action="{% url 'advisor_project_wordlogs_csv' project.pk %}" class="d-flex align-items-center gap-2">
            <input type="date" name="start" class="form-control form-control-sm" placeholder="Start" value="{{ export_filters.start }}">
            <input type="date" name="end" class="form-control form-control-sm" placeholder="End" value="{{ export_filters.end }}">
            <select name="milestone" class="form-select form-select-sm">
              <option value="">All milestones</option>
              {% for m in milestones %}
                <option value="{{ m.id }}" {% if export_filters.milestone|add:'' == m.id|add:'' %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-secondary" type="submit">Logs CSV</button>
          </form>
          <form method="get" action="{% url 'advisor_project' project.pk %}">
            <input type="hidden" name="clear_export" value="1">
            <button class="btn btn-sm btn-link text-decoration-none" type="submit">Clear</button>
          </form>
          <div class="w-100 text-muted small mt-1">
            Tip: set optional start/end dates (YYYY-MM-DD) and/or milestone to filter the logs CSV for this project.
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <form method="get" class="p-2">
          <div class="row g-2 align-items-end">
            <div class="col-auto">
              <label class="form-label">Search</label>
              <input class="form-control form-control-sm" type="text" name="q" value="{{ q|default:'' }}" placeholder="Task title">
            </div>
            <div class="col-auto">
              <label class="form-label">Status</label>
              <select name="status" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="todo" {% if status_filter == 'todo' %}selected{% endif %}>To Do</option>
                <option value="doing" {% if status_filter == 'doing' %}selected{% endif %}>Doing</option>
                <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
              </select>
            </div>
            <div class="col-auto">
              <label class="form-label">Milestone</label>
              <select name="milestone" class="form-select form-select-sm">
                <option value="">All</option>
                {% for m in milestones %}
                  <option value="{{ m.id }}" {% if milestone_id|add:'' == m.id|add:'' %}selected{% endif %}>{{ m.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-auto">
              <label class="form-label">Order</label>
              <select name="order" class="form-select form-select-sm">
                <option value="milestone" {% if order == 'milestone' %}selected{% endif %}>Milestone/Order</option>
                <option value="due" {% if order == 'due' %}selected{% endif %}>Due date</option>
                <option value="priority" {% if order == 'priority' %}selected{% endif %}>Priority</option>
              </select>
            </div>
            <div class="col-auto form-check mt-4">
              <input class="form-check-input" type="checkbox" id="f_has_target" name="has_target" value="1" {% if has_target %}checked{% endif %}>
              <label for="f_has_target" class="form-check-label">Has target</label>
            </div>
            <div class="col-auto form-check mt-4">
              <input class="form-check-input" type="checkbox" id="f_drafts" name="drafts" value="1" {% if drafts %}checked{% endif %}>
              <label for="f_drafts" class="form-check-label">Drafts</label>
            </div>
            <div class="col-auto">
              <label class="form-label">Due ≤ days</label>
              <input class="form-control form-control-sm" type="number" min="1" name="due" value="{{ due }}">
            </div>
            <div class="col-auto">
              <label class="form-label">Per page</label>
              <input class="form-control form-control-sm" type="number" min="5" max="100" name="per" value="{{ per|default:25 }}">
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-outline-primary" type="submit">Filter</button>
            </div>
          </div>
        </form>
        <div class="px-2 pb-2"><a class="small" href="{% url "advisor_project" project.pk %}">Clear filters</a></div>
        <table class="table table-sm mb-0">
          <thead><tr><th>Milestone</th><th>Task</th><th>Status</th></tr></thead>
          <tbody>
            {% for t in tasks %}
              <tr>
                <td>{{ t.milestone.name }}</td>
                <td>
                  {{ t.title }}
                  <span class="nowrap">
                    {% if t.gated_blocked %}
                      <span class="badge rounded-pill text-bg-secondary ms-1 badge-tight" data-bs-toggle="tooltip" title="Locked until previous stage is completed: {{ t.gated_wait }}">
                        <i class="bi bi-lock-fill"></i>
                      </span>
                    {% endif %}
                    {% if show_effort and t.word_target and t.word_target|add:0 > 0 %}
                      <span class="text-muted small ms-2">Target: {{ t.word_target }} words</span>
                    {% endif %}
                  </span>
                </td>
                <td>{{ t.get_status_display }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-muted">No tasks.</td></tr>
            {% endfor %}
          </tbody>
        </table>
        {% if page_obj %}
        <div class="p-2">
          <nav aria-label="Tasks pages">
            <ul class="pagination pagination-sm mb-0">
              {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}&milestone={{ milestone_id }}&q={{ q }}&order={{ order }}&per={{ per }}&has_target={% if has_target %}1{% endif %}&drafts={% if drafts %}1{% endif %}&due={{ due }}">Prev</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Prev</span></li>
              {% endif %}
              <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
              {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}&milestone={{ milestone_id }}&q={{ q }}&order={{ order }}&per={{ per }}&has_target={% if has_target %}1{% endif %}&drafts={% if drafts %}1{% endif %}&due={{ due }}">Next</a></li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">Project Notes</div>
      <div class="card-body">
        {% if notes %}
          <div class="list-group">
            {% for n in notes %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <strong>{{ n.title }}</strong>
                  <span class="text-muted small">{{ n.created_at }} by {{ n.author.username }}</span>
                </div>
                <div>{{ n.body|md }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">No notes.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">Attachments</div>
      <div class="card-body">
        {% if docs %}
          <ul class="list-unstyled">
            {% for d in docs %}
              <li class="mb-2">
                <a href="{{ d.file.url }}" target="_blank">{{ d.filename }}</a>
                <span class="text-muted small">({{ d.size }} bytes){% if d.task %} — {{ d.task.title }}{% endif %}</span>
                {% if d.notes %}<div class="text-muted small">{{ d.notes }}</div>{% endif %}
                {% if d.content_type|startswith:"image/" %}
                  <div class="mt-1"><img src="{{ d.file.url }}" alt="{{ d.filename }}" class="img-fluid" style="max-height:160px"></div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">No attachments.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">Milestones</div>
      <div class="card-body">
        {% if milestone_progress %}
          <div class="list-group">
            {% for mp in milestone_progress %}
              <div class="list-group-item d-flex align-items-center gap-3">
                <div>{% donut mp.percent 48 7 %}</div>
                <div class="flex-grow-1 d-flex justify-content-between">
                  <strong>{{ mp.m.name }}</strong>
                  <span class="text-muted"><span class="badge text-bg-light">{{ mp.percent }}%</span> ({{ mp.done }}/{{ mp.total }})</span>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">No milestones.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">Feedback</div>
      <div class="card-body">
        <form method="post">{% csrf_token %}
          <input type="hidden" name="new_feedback" value="1" />
          <div class="mb-2"><textarea class="form-control" name="note" rows="2" placeholder="Request feedback or leave a note to the student"></textarea></div>
          <div class="row g-2 mb-2">
            <div class="col-auto">
              <label class="form-label">Task (optional)</label>
              <select name="task_id" class="form-select form-select-sm">
                <option value="">—</option>
                {% for t in tasks %}
                  <option value="{{ t.id }}">{{ t.milestone.name }} — {{ t.title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-auto">
              <label class="form-label">Document (optional)</label>
              <select name="document_id" class="form-select form-select-sm">
                <option value="">—</option>
                {% for d in docs %}
                  <option value="{{ d.id }}">{{ d.filename }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <button class="btn btn-sm btn-primary" type="submit">Create request</button>
        </form>
        <hr>
        {% if feedback %}
          <div class="accordion" id="fb">
            {% for fr in feedback %}
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fr{{ fr.pk }}">Request #{{ fr.pk }} — {{ fr.status }}</button>
                </h2>
                <div id="fr{{ fr.pk }}" class="accordion-collapse collapse" data-bs-parent="#fb">
                  <div class="accordion-body">
                    <div class="mb-2">{{ fr.note|linebreaks }}</div>
                    <div class="mb-2">
                      <strong>Comments</strong>
                      <ul class="list-unstyled mb-2">
                        {% for c in fr.comments.all %}
                          <li class="mb-1"><span class="text-muted small">{{ c.author.username }}:</span> {{ c.message|linebreaks }}</li>
                        {% empty %}
                          <li class="text-muted">No comments yet.</li>
                        {% endfor %}
                      </ul>
                      <form method="post">{% csrf_token %}
                        <input type="hidden" name="add_comment" value="1" />
                        <input type="hidden" name="request_id" value="{{ fr.pk }}" />
                        <div class="input-group input-group-sm">
                          <input class="form-control" name="message" placeholder="Add comment...">
                          <button class="btn btn-outline-secondary" type="submit">Send</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">No feedback requests.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
