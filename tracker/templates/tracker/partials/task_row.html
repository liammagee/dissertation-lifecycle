{% load vis %}
<tr id="task-{{ task.pk }}" class="task-row" tabindex="0" data-task-id="{{ task.pk }}" data-milestone-id="{{ task.milestone.id }}">
  <td class="text-muted" style="width:28px">
    <span class="drag-handle" title="Drag to reorder" aria-label="Drag to reorder" draggable="true" data-bs-toggle="tooltip" style="cursor:grab; user-select:none; display:inline-block">
      <i class="bi bi-grip-vertical"></i>
    </span>
  </td>
  <td>{{ task.milestone.name }}</td>
  <td>
    <div class="task-grid{% if show_effort %} full{% endif %}">
      <div>
        <a href="{% url 'task_detail' task.pk %}">{{ task.title }}</a>
        <span class="nowrap">
          {% if task.template and task.template.guidance_tips or task.template and task.template.guidance_url %}
            <button type="button"
                    class="badge rounded-pill text-bg-info ms-1 border-0 badge-tight"
                    style="cursor:pointer"
                    title="View quick guidance"
                    data-bs-toggle="tooltip"
                    hx-get="{% url 'task_guidance' task.pk %}"
                    hx-target="#guidance-body"
                    hx-swap="innerHTML"
                    hx-indicator="#tsk-{{ task.pk }}-spin">
              Tips
            </button>
          {% endif %}
          {% if task.gated_blocked %}
            <span class="badge rounded-pill text-bg-secondary ms-1 badge-tight" data-bs-toggle="tooltip" title="Locked until previous stage is completed: {{ task.gated_wait }}">
              <i class="bi bi-lock-fill"></i>
            </span>
          {% endif %}
        </span>
      </div>
      <div class="task-actions">
        <div id="tsk-{{ task.pk }}-spin" class="spinner-border spinner-border-sm text-secondary" role="status" style="display:none"><span class="visually-hidden">Loading…</span></div>
        {% if task.can_move_up %}
          <form method="post" action="{% url 'task_move' task.pk 'up' %}" class="d-inline move-up"
                hx-post="{% url 'task_move' task.pk 'up' %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML" hx-indicator="#tsk-{{ task.pk }}-spin">{% csrf_token %}
            <button class="btn btn-sm btn-outline-secondary" title="Move up" data-bs-toggle="tooltip">
              <i class="bi bi-chevron-up"></i><span class="visually-hidden"> Move up</span>
            </button>
          </form>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-chevron-up"></i></button>
        {% endif %}
        {% if task.can_move_down %}
          <form method="post" action="{% url 'task_move' task.pk 'down' %}" class="d-inline move-down"
                hx-post="{% url 'task_move' task.pk 'down' %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML" hx-indicator="#tsk-{{ task.pk }}-spin">{% csrf_token %}
            <button class="btn btn-sm btn-outline-secondary" title="Move down" data-bs-toggle="tooltip">
              <i class="bi bi-chevron-down"></i><span class="visually-hidden"> Move down</span>
            </button>
          </form>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-chevron-down"></i></button>
        {% endif %}
        <a class="btn btn-sm btn-outline-danger" href="{% url 'task_delete' task.pk %}" title="Delete task" data-bs-toggle="tooltip">
          <i class="bi bi-trash"></i><span class="visually-hidden"> Delete</span>
        </a>
        <a class="btn btn-sm btn-outline-primary" href="{% url 'wordlogs' %}?task={{ task.pk }}#log-form" title="Log words" data-bs-toggle="tooltip">
          <i class="bi bi-journal-plus"></i><span class="visually-hidden"> Log words</span>
        </a>
      </div>
      {% if show_effort %}
      <div class="task-target">
        <form method="post" action="{% url 'task_target' task.pk %}" class="d-inline" hx-post="{% url 'task_target' task.pk %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML" hx-indicator="#tsk-{{ task.pk }}-spin" hx-trigger="change from:input, keyup changed delay:500ms from:input">{% csrf_token %}
          <input name="word_target" type="number" min="0" value="{{ task.word_target|default:0 }}" placeholder="Target" aria-label="Target words" class="form-control form-control-sm d-inline" />
          <button class="btn btn-sm btn-outline-secondary btn-icon" name="explicit" value="1" title="Save target" data-bs-toggle="tooltip"><i class="bi bi-check2"></i><span class="visually-hidden"> Save</span></button>
        </form>
        {% if just_saved %}
          <span class="saved-chip animate">Saved</span>
        {% endif %}
        {% if task.word_target|default:0|add:0 == 0 %}
          <span class="ms-1" tabindex="0" class="tip" data-bs-toggle="tooltip" title="Set a word target to calculate effort">i</span>
        {% endif %}
        {% if task.template and task.template.guidance_tips %}
          <button class="btn btn-sm btn-outline-secondary ms-1" title="Guidance" data-bs-toggle="tooltip"
                  hx-get="{% url 'task_guidance' task.pk %}"
                  hx-target="#guidance-body"
                  hx-swap="innerHTML" hx-indicator="#tsk-{{ task.pk }}-spin">
            <i class="bi bi-lightbulb"></i><span class="visually-hidden"> Guidance</span>
          </button>
        {% elif task.template and task.template.guidance_url %}
          <button class="btn btn-sm btn-outline-secondary ms-1" title="Guidance" data-bs-toggle="tooltip"
                  hx-get="{% url 'task_guidance' task.pk %}"
                  hx-target="#guidance-body"
                  hx-swap="innerHTML" hx-indicator="#tsk-{{ task.pk }}-spin">
            <i class="bi bi-lightbulb"></i><span class="visually-hidden"> Guidance</span>
          </button>
        {% endif %}
      </div>
      {% else %}
      <div></div>
      {% endif %}
      {% if show_effort %}
      <div>
        {% if task.word_target|default:0|add:0 == 0 %}
          <span class="badge text-bg-secondary badge-fixed" data-bs-toggle="tooltip" title="Set a word target to calculate effort">Effort —</span>
        {% else %}
          {% if task.effort_pct >= 75 %}
            <span class="badge text-bg-success badge-fixed" data-bs-toggle="tooltip" title="Effort = words logged for this task ÷ word target">Effort {{ task.effort_pct }}%</span>
          {% elif task.effort_pct >= 30 %}
            <span class="badge text-bg-warning badge-fixed" data-bs-toggle="tooltip" title="Effort = words logged for this task ÷ word target">Effort {{ task.effort_pct }}%</span>
          {% else %}
            <span class="badge text-bg-danger badge-fixed" data-bs-toggle="tooltip" title="Effort = words logged for this task ÷ word target">Effort {{ task.effort_pct }}%</span>
          {% endif %}
        {% endif %}
      </div>
      <div>
        <span class="badge text-bg-light badge-fixed" data-bs-toggle="tooltip" title="Combined = weighted average of status and effort (set weights above)">Combined {{ task.combined_pct }}%</span>
      </div>
      {% else %}
      <div></div>
      <div></div>
      {% endif %}
    </div>
  </td>
  <td>{{ task.due_date|default:'—' }}</td>
  <td>
    <form id="form-{{ task.pk }}" method="post" action="{% url 'task_status' task.pk %}" hx-post="{% url 'task_status' task.pk %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML" hx-indicator="#tsk-{{ task.pk }}-spin" class="status-form" hx-trigger="never">{% csrf_token %}
      <input type="hidden" name="percent" value="{{ task.progress_percent }}" />
      {% if task.gated_blocked %}
        <span class="tooltip-wrapper" data-bs-toggle="tooltip" title="Complete {{ task.gated_wait }} first">
        <input type="range" min="0" max="100" step="5" list="progressTicks"
                 value="{{ task.progress_percent }}"
                 class="form-range flex-grow-1 progress-slider" disabled aria-disabled="true" style="pointer-events:none;" />
        </span>
      {% else %}
        <input type="range" min="0" max="100" step="5" list="progressTicks"
               value="{{ task.progress_percent }}"
               class="form-range flex-grow-1 progress-slider"
               title="Progress: move to update status (0%=To Do, 1-99%=Doing, 100%=Done)" style="min-width:120px;" />
      {% endif %}
      <select id="status-{{ task.pk }}" name="status" class="form-select d-none" onchange="this.form.requestSubmit()">
          <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
          <option value="doing" {% if task.status == 'doing' %}selected{% endif %}>Doing</option>
          <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
        </select>
    </form>
  </td>
  <td>
    <select name="status-display" class="form-select form-select-sm" onchange="var f=document.getElementById('form-{{ task.pk }}'); f.querySelector('select[name=status]').value=this.value; f.requestSubmit();" {% if task.gated_blocked %}disabled aria-disabled="true" data-bs-toggle="tooltip" title="Complete {{ task.gated_wait }} first"{% endif %} data-form-id="form-{{ task.pk }}">
      <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
      <option value="doing" {% if task.status == 'doing' %}selected{% endif %}>Doing</option>
      <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
    </select>
  </td>
</tr>
{% if toast_message %}
<div id="toastContainer" hx-swap-oob="beforeend">
  <div class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000" data-autonew="1">
    <div class="d-flex">
      <div class="toast-body">{{ toast_message }}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endif %}
