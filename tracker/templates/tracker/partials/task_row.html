{% load vis %}
<tr id="task-{{ task.pk }}" class="task-row" tabindex="0" data-task-id="{{ task.pk }}">
  <td>{{ task.milestone.name }}</td>
  <td>
    <div class="task-grid">
      <div>
        <a href="{% url 'task_detail' task.pk %}">{{ task.title }}</a>
      </div>
      <div class="task-actions">
        {% if task.can_move_up %}
          <form method="post" action="{% url 'task_move' task.pk 'up' %}" class="d-inline move-up"
                hx-post="{% url 'task_move' task.pk 'up' %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML">{% csrf_token %}
            <button class="btn btn-sm btn-outline-secondary" title="Move up">↑</button>
          </form>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>↑</button>
        {% endif %}
        {% if task.can_move_down %}
          <form method="post" action="{% url 'task_move' task.pk 'down' %}" class="d-inline move-down"
                hx-post="{% url 'task_move' task.pk 'down' %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML">{% csrf_token %}
            <button class="btn btn-sm btn-outline-secondary" title="Move down">↓</button>
          </form>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>↓</button>
        {% endif %}
        <a class="btn btn-sm btn-outline-danger" href="{% url 'task_delete' task.pk %}">Delete</a>
        {% if task.status != 'done' %}
          <form method="post" action="{% url 'task_status' task.pk %}" class="d-inline ms-1"
                hx-post="{% url 'task_status' task.pk %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML">{% csrf_token %}
            <input type="hidden" name="status" value="done" />
            <label class="form-check-label small">
              <input type="checkbox" class="form-check-input" onchange="this.form.requestSubmit()"> Done
            </label>
          </form>
        {% else %}
          <span class="badge text-bg-success ms-1">Done</span>
        {% endif %}
      </div>
      <div class="task-target">
        <form method="post" action="{% url 'task_target' task.pk %}" class="d-inline" hx-post="{% url 'task_target' task.pk %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML">{% csrf_token %}
          <span class="text-muted small">Target:</span>
          <input name="word_target" type="number" min="0" value="{{ task.word_target|default:0 }}" class="form-control form-control-sm d-inline" />
          <button class="btn btn-sm btn-outline-secondary">Save</button>
        </form>
        {% if task.template and task.template.guidance_tips %}
          <button class="btn btn-sm btn-outline-secondary ms-1"
                  hx-get="{% url 'task_guidance' task.pk %}"
                  hx-target="#guidance-body"
                  hx-swap="innerHTML">
            Guidance
          </button>
        {% elif task.template and task.template.guidance_url %}
          <button class="btn btn-sm btn-outline-secondary ms-1"
                  hx-get="{% url 'task_guidance' task.pk %}"
                  hx-target="#guidance-body"
                  hx-swap="innerHTML">
            Guidance
          </button>
        {% endif %}
      </div>
      <div>
        {% if task.effort_pct >= 75 %}
          <span class="badge text-bg-success badge-fixed">Effort {{ task.effort_pct }}%</span>
        {% elif task.effort_pct >= 30 %}
          <span class="badge text-bg-warning badge-fixed">Effort {{ task.effort_pct }}%</span>
        {% else %}
          <span class="badge text-bg-danger badge-fixed">Effort {{ task.effort_pct }}%</span>
        {% endif %}
      </div>
      <div>
        <span class="badge text-bg-light badge-fixed">Combined {{ task.combined_pct }}%</span>
      </div>
    </div>
  </td>
  <td>{{ task.due_date|default:'—' }}</td>
  <td>
    <form method="post" action="{% url 'task_status' task.pk %}" hx-post="{% url 'task_status' task.pk %}" hx-target="#task-{{ task.pk }}" hx-swap="outerHTML">{% csrf_token %}
      <select name="status" class="form-select form-select-sm" onchange="this.form.requestSubmit()">
        <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>To Do</option>
        <option value="doing" {% if task.status == 'doing' %}selected{% endif %}>Doing</option>
        <option value="done" {% if task.status == 'done' %}selected{% endif %}>Done</option>
      </select>
    </form>
  </td>
</tr>
