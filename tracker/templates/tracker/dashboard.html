{% extends 'tracker/base.html' %}
{% load vis %}
{% block content %}
<h2>{{ project.title }}</h2>
{% if quote %}
  <div class="alert alert-secondary py-2">
    <em>“{{ quote.text }}”</em>
    <span class="ms-2">— {{ quote.author }}</span>
  </div>
{% endif %}
{% if badges %}
  <div class="mb-2">
    {% for b in badges %}
      <span class="badge rounded-pill text-bg-info me-1">{{ b }}</span>
    {% endfor %}
  </div>
{% endif %}
<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-auto">
    <label for="w_status" class="form-label">Status weight (%)</label>
    <input type="number" min="0" class="form-control" id="w_status" name="w_status" value="{{ w_status|default:70 }}">
  </div>
  <div class="col-auto">
    <label for="w_effort" class="form-label">Effort weight (%)</label>
    <input type="number" min="0" class="form-control" id="w_effort" name="w_effort" value="{{ w_effort|default:30 }}">
  </div>
  <div class="col-auto">
    <input type="hidden" name="update_weights" value="1" />
    <button class="btn btn-outline-primary" type="submit">Update weighting</button>
  </div>
</form>
<div class="text-muted small mb-3">
  Effort badge colors: <span class="badge text-bg-danger">&lt;30%</span>,
  <span class="badge text-bg-warning">30–74%</span>,
  <span class="badge text-bg-success">≥75%</span>.
  Milestone % uses combined(Status {{ w_status|default:70 }}%, Effort {{ w_effort|default:30 }}%).
  Adjust weights above to favor status completion vs writing effort.
</div>
<div class="mb-3 d-flex align-items-center gap-3">
  <div>{% donut completion 120 14 %}</div>
  <div>
    <div>Overall completion</div>
    <div class="text-muted">{{ completion }}%</div>
    <div class="text-muted small">Legend: donut shows project completion percentage.</div>
  </div>
 </div>

{% if milestone_progress %}
<div class="mb-3">
  <h5>Milestones</h5>
  <div class="list-group">
    {% for mp in milestone_progress %}
      <div class="list-group-item d-flex align-items-center gap-3">
        <div>{% donut mp.percent 60 8 %}</div>
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between"><strong>{{ mp.m.name }}</strong><span class="text-muted"><span class="badge text-bg-light">{{ mp.percent }}%</span> ({{ mp.done }}/{{ mp.total }})</span></div>
        </div>
      </div>
    {% endfor %}
  </div>
 </div>
{% endif %}

<div class="mb-4 d-flex justify-content-between align-items-center">
  <h5>Radar Overview</h5>
  <a class="btn btn-sm btn-outline-success" href="{% url 'task_new' %}">+ New Task</a>
  <form method="get" class="row g-2 align-items-end mb-2">
    <input type="hidden" name="update_radar" value="1" />
    <div class="col-auto form-check">
      <input class="form-check-input" type="checkbox" id="f_grid" name="show_grid" value="1" {% if radar_show_grid %}checked{% endif %}>
      <label for="f_grid" class="form-check-label">Show grid</label>
    </div>
    <div class="col-auto form-check">
      <input class="form-check-input" type="checkbox" id="f_labels" name="show_labels" value="1" {% if radar_show_labels %}checked{% endif %}>
      <label for="f_labels" class="form-check-label">Show labels</label>
    </div>
    <div class="col-auto">
      <label for="f_speed" class="form-label">Sweep speed (s)</label>
      <input type="number" min="1" max="20" class="form-control" id="f_speed" name="speed" value="{{ radar_speed }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-outline-primary" type="submit">Update</button>
    </div>
  </form>
  {% radar radar_points 320 18 radar_show_grid radar_show_labels radar_speed %}
  <div class="text-muted small mt-2">Legend: center = more progress; ring distance indicates remaining work. Points represent milestones.</div>
</div>

<form method="get" class="mb-2">
  <div class="row g-2 align-items-end">
    <div class="col-auto">
      <label class="form-label">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="">All</option>
        <option value="todo" {% if status_filter == 'todo' %}selected{% endif %}>To Do</option>
        <option value="doing" {% if status_filter == 'doing' %}selected{% endif %}>Doing</option>
        <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Done</option>
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">Milestone</label>
      <select name="milestone" class="form-select form-select-sm">
        <option value="">All</option>
        {% for m in milestones %}
          <option value="{{ m.id }}" {% if milestone_id|add:'' == m.id|add:'' %}selected{% endif %}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto form-check mt-4">
      <input class="form-check-input" type="checkbox" id="s_has_target" name="has_target" value="1" {% if has_target %}checked{% endif %}>
      <label for="s_has_target" class="form-check-label">Has target</label>
    </div>
    <div class="col-auto form-check mt-4">
      <input class="form-check-input" type="checkbox" id="s_drafts" name="drafts" value="1" {% if drafts %}checked{% endif %}>
      <label for="s_drafts" class="form-check-label">Drafts</label>
    </div>
    <div class="col-auto">
      <label class="form-label">Due ≤ days</label>
      <input class="form-control form-control-sm" type="number" min="1" name="due" value="{{ due }}">
    </div>
    <div class="col-auto">
      <button class="btn btn-sm btn-outline-primary" type="submit">Filter</button>
    </div>
  </div>
 </form>
 <div class="mb-2"><a class="small" href="{% url "dashboard" %}">Clear filters</a></div>

<table class="table table-sm align-middle">
  <thead>
    <tr><th>Milestone</th><th>Task</th><th>Due</th><th>Status</th></tr>
  </thead>
  <tbody>
    {% for task in tasks %}
      {% include 'tracker/partials/task_row.html' with task=task %}
    {% empty %}
      <tr><td colspan="4" class="text-muted">No tasks yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
<div class="text-muted small mb-4 d-flex align-items-center justify-content-between">
  <span>
    Shortcuts: j/k or Arrow ↑/↓ to move focus; Shift+Arrow ↑/↓ to reorder within milestone.
    After a move, focus stays on the task so you can keep adjusting quickly.
  </span>
  <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shortcutsModal">? Shortcuts</button>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade" id="shortcutsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Keyboard Shortcuts</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="mb-0">
          <li><strong>j</strong> or <strong>Arrow ↓</strong>: Focus next task</li>
          <li><strong>k</strong> or <strong>Arrow ↑</strong>: Focus previous task</li>
          <li><strong>Shift + Arrow ↑</strong>: Move task up (within milestone)</li>
          <li><strong>Shift + Arrow ↓</strong>: Move task down (within milestone)</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  </div>
<script>
  (function(){
    function rows(){ return Array.from(document.querySelectorAll('tr.task-row')); }
    function focusRow(idx){
      var r = rows()[idx];
      if (r) { r.focus({preventScroll:false}); r.classList.add('table-active');
        setTimeout(function(){ r.classList.remove('table-active'); }, 120); }
    }
    function currentIndex(){
      var rws = rows();
      var el = document.activeElement;
      while (el && el.tagName && el.tagName.toLowerCase() !== 'tr') { el = el.parentElement; }
      return rws.indexOf(el);
    }
    // Initial focus on first row
    window.addEventListener('load', function(){ if (!document.activeElement || document.activeElement === document.body) focusRow(0); });
    document.addEventListener('keydown', function(e){
      var idx = currentIndex();
      if (e.key === 'j' || (e.key === 'ArrowDown' && !e.shiftKey)){
        e.preventDefault(); focusRow(Math.min(rows().length-1, idx + 1));
      } else if (e.key === 'k' || (e.key === 'ArrowUp' && !e.shiftKey)){
        e.preventDefault(); focusRow(Math.max(0, idx - 1));
      } else if (e.shiftKey && e.key === 'ArrowUp'){
        // move up
        var tr = rows()[idx]; if (!tr) return;
        var form = tr.querySelector('form.move-up'); if (form){ e.preventDefault(); form.requestSubmit(); }
      } else if (e.shiftKey && e.key === 'ArrowDown'){
        // move down
        var tr2 = rows()[idx]; if (!tr2) return;
        var form2 = tr2.querySelector('form.move-down'); if (form2){ e.preventDefault(); form2.requestSubmit(); }
      }
    });
    // Keep focus on the moved row after HTMX swap
    document.body.addEventListener('htmx:afterSwap', function(evt){
      var t = evt.target; if (!t || !t.id) return;
      if (t.matches && t.matches('tr.task-row')){ t.focus(); }
    });
  })();
  </script>
{% endblock %}
