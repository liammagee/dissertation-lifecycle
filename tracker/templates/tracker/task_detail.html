{% extends 'tracker/base.html' %}
{% load md vis %}
{% block content %}
<div class="d-flex justify-content-between align-items-center">
  <h2>{{ task.title }}
    {% if task.word_target and task.word_target|add:0 > 0 %}
      <span class="text-muted small ms-2">Target: {{ task.word_target }} words</span>
    {% endif %}
  </h2>
  <div>
    {% if task.status != 'done' %}
      <form method="post" action="{% url 'task_status' task.pk %}" class="d-inline">{% csrf_token %}
        <input type="hidden" name="status" value="done" />
        {% if next_task %}<input type="hidden" name="next" value="{% url 'task_detail' next_task.pk %}">{% endif %}
        <button class="btn btn-sm btn-success me-1" type="submit">Mark Done</button>
      </form>
    {% endif %}
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'task_edit' task.pk %}">Edit</a>
  </div>
 </div>
<p class="text-muted">Milestone: {{ task.milestone.name }} | Due: {{ task.due_date|default:'—' }} | Priority: {{ task.get_priority_display }} | Status: {{ task.get_status_display }}</p>
{% if word_target and effort_pct >= 100 and task.status != 'done' %}
  <div class="alert alert-success d-flex justify-content-between align-items-center">
    <div>You reached your word target for this task. Mark as done?</div>
    <form method="post" action="{% url 'task_status' task.pk %}">{% csrf_token %}
      <input type="hidden" name="status" value="done" />
      <button class="btn btn-sm btn-success" type="submit">Mark Done</button>
    </form>
  </div>
{% endif %}

<div class="row g-3">
  <div class="col-md-7">
    <div class="card">
      <div class="card-header">Description</div>
      <div class="card-body">
        {{ task.description|linebreaks|default:"<span class='text-muted'>No description.</span>"|safe }}
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-header">My Notes</div>
      <div class="card-body">
        {{ task.user_notes|md|default:"<span class='text-muted'>No notes yet. Use Edit to add your notes.</span>"|safe }}
        <div class="mt-2"><a class="btn btn-sm btn-outline-secondary" href="{% url 'task_edit' task.pk %}">Edit Notes</a></div>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card">
      <div class="card-header">Guidance</div>
      <div class="card-body">
        {% if tpl and tpl.guidance_tips %}
          <div class="mb-2">{{ tpl.guidance_tips|linebreaks }}</div>
        {% else %}
          <div class="text-muted">No tips provided for this task yet.</div>
        {% endif %}
        {% if tpl and tpl.guidance_url %}
          <a class="btn btn-sm btn-outline-primary" href="{{ tpl.guidance_url }}" target="_blank">Learn more</a>
        {% endif %}
      </div>
    </div>
    {% if next_task %}
    <div class="mt-3">
      <a class="btn btn-sm btn-outline-primary" href="{% url 'task_detail' next_task.pk %}">Next Task → {{ next_task.title }}</a>
    </div>
    {% endif %}
    <div class="card mt-3">
      <div class="card-header">Attachments</div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'upload_document' task.pk %}">{% csrf_token %}
          <div class="mb-2">{{ upload_form.file }} {{ upload_form.notes }}</div>
          <button class="btn btn-sm btn-primary" type="submit">Upload</button>
        </form>
        <hr>
        {% if docs %}
          <ul class="list-unstyled">
            {% for d in docs %}
              <li class="mb-1">
                <a href="{{ d.file.url }}" target="_blank">{{ d.filename }}</a>
                <span class="text-muted">({{ d.size }} bytes)</span>
                {% if d.notes %}<div class="text-muted small">{{ d.notes }}</div>{% endif %}
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'edit_document' d.pk %}">Edit notes</a>
                <form method="post" action="{% url 'delete_document' d.pk %}" style="display:inline">{% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
                {% if d.content_type|startswith:"image/" %}
                  <div class="mt-1"><img src="{{ d.file.url }}" alt="{{ d.filename }}" class="img-fluid" style="max-height:160px"></div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">No attachments yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
