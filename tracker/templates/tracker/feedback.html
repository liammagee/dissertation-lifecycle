{% extends 'tracker/base.html' %}
{% block content %}
<h2>Request Feedback</h2>
<p class="text-muted">Create a feedback request for your advisor. Optionally link a specific task or uploaded document.</p>

<form method="post" class="mb-4">{% csrf_token %}
  <div class="mb-2">
    <label class="form-label">Note to advisor</label>
    <textarea class="form-control" name="note" rows="3" placeholder="What would you like feedback on?"></textarea>
  </div>
  <div class="row g-2 mb-3">
    <div class="col-md-5">
      <label class="form-label">Task (optional)</label>
      <select class="form-select" name="task_id">
        <option value="">—</option>
        {% for t in tasks %}
          <option value="{{ t.id }}">{{ t.milestone.name }} — {{ t.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">Document (optional)</label>
      <select class="form-select" name="document_id">
        <option value="">—</option>
        {% for d in docs %}
          <option value="{{ d.id }}">{{ d.filename }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Send</button>
    </div>
  </div>
</form>

<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Your Feedback Requests</h5>
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'my_export_zip' %}">Export My Data (ZIP)</a>
 </div>

{% if feedback %}
  <div class="accordion" id="fb-student">
    {% for fr in feedback %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#frs{{ fr.pk }}">
            Request #{{ fr.pk }} — {{ fr.status }} {% if fr.task %} — {{ fr.task.title }}{% endif %}
          </button>
        </h2>
        <div id="frs{{ fr.pk }}" class="accordion-collapse collapse" data-bs-parent="#fb-student">
          <div class="accordion-body">
            <div class="mb-2">{{ fr.note|linebreaks }}</div>
            {% if fr.document %}
              <div class="mb-2 small">Document: <a href="{{ fr.document.file.url }}" target="_blank">{{ fr.document.filename }}</a></div>
            {% endif %}
            <div>
              <strong>Comments</strong>
              <ul class="list-unstyled mb-2">
                {% for c in fr.comments.all %}
                  <li class="mb-1"><span class="text-muted small">{{ c.author.username }}:</span> {{ c.message|linebreaks }}</li>
                {% empty %}
                  <li class="text-muted">No comments yet.</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-muted">No feedback requests yet.</div>
{% endif %}
{% endblock %}

