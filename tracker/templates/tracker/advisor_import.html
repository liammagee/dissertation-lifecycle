{% extends 'tracker/base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="mb-0">Advisor Import</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'advisor_export_import_csv' %}"><i class="bi bi-upload me-1"></i>Export (re‑importable)</a>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'advisor_import_template' %}"><i class="bi bi-filetype-csv me-1"></i>Template</a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <p class="text-muted">Upload a CSV with columns: <code>username,email,title,apply_templates,status,password</code>. Existing users/projects are updated; missing ones are created. Password is optional; leave blank to set an unusable password (students can use password reset).</p>
    <form method="post" enctype="multipart/form-data" class="mb-2">{% csrf_token %}
      <div class="mb-3">{{ form.file.label_tag }} {{ form.file }}<div class="text-muted small">{{ form.file.help_text }}</div></div>
      <div class="row g-3">
        <div class="col-md-3 form-check">
          {{ form.update_only }} <label class="form-check-label" for="id_update_only">Update only (no creates)</label>
        </div>
        <div class="col-md-3 form-check">
          {{ form.dry_run }} <label class="form-check-label" for="id_dry_run">Dry run (no changes)</label>
        </div>
        <div class="col-md-3 form-check">
          {{ form.create_missing_users }} <label class="form-check-label" for="id_create_missing_users">Create missing users</label>
          <div class="text-muted small">Overrides Update only for users.</div>
        </div>
        <div class="col-md-3 form-check">
          {{ form.create_missing_projects }} <label class="form-check-label" for="id_create_missing_projects">Create missing projects</label>
          <div class="text-muted small">Overrides Update only for projects.</div>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary" type="submit"><i class="bi bi-download me-1"></i>Import</button>
        <a class="btn btn-outline-secondary" href="{% url 'advisor_export_import_csv' %}">Export (re‑importable) CSV</a>
        <a class="btn btn-outline-secondary" href="{% url 'advisor_import_template' %}">Download Template</a>
      </div>
    </form>
    <div class="text-muted small">
      <strong>How to import</strong>
      <ol class="mb-0">
        <li>Download the <a href="{% url 'advisor_import_template' %}">template CSV</a> or use the <a href="{% url 'advisor_export_import_csv' %}">re‑importable export</a> as a starting point.</li>
        <li>Fill or update rows. Tips: set <code>apply_templates=1</code> for brand‑new projects; leave <code>password</code> blank to let students use password reset.</li>
        <li>Choose <em>Update only</em> if you don’t want creations. Enable <em>Create missing users/projects</em> to allow specific creates.</li>
        <li>Use <em>Dry run</em> to preview without writing changes.</li>
        <li>Upload the file and click <em>Import</em>; review the results list for any issues.</li>
      </ol>
      <div class="mt-1">Columns: <code>username,email,title,apply_templates,status,password,display_name,new_title</code></div>
      <div>Values: <code>apply_templates</code> accepts 1/true/yes; <code>status</code> is <code>active</code> or <code>archived</code>.</div>
    </div>
  </div>
</div>

{% if results %}
  <div class="card shadow-sm">
    <div class="card-header">Results</div>
    <div class="card-body">
      <ul class="mb-0">
        {% for kind,msg in results %}
          <li class="{% if kind == 'error' %}text-danger{% endif %}">{{ msg }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endif %}
{% endblock %}
